@page "/"
@layout Poe.Components.Layout.PublicLayout
@using System.Security.Claims
@using Hannibal.Client
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.BearerToken
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Http.HttpResults
@using Microsoft.AspNetCore.Identity.Data
@inject IHttpContextAccessor HttpContextAccessor
@inject IIdentityApiService IdentityApiService
@inject NavigationManager Navigation
@inject Tools.AppBasePath BasePath
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Backer - Backup Manager</PageTitle>

<AuthorizeView>
    <Authorized>
        @* Redirect authenticated users to dashboard *@
    </Authorized>
    <NotAuthorized Context="authContext">
        <div class="landing-container">
            <div class="landing-hero">
                <div class="hero-content">
                    <h1 class="hero-title">
                        <span class="hero-icon">‚òÅÔ∏è</span>
                        Backer
                    </h1>
                    <p class="hero-subtitle">
                        Automated backup management powered by rclone.<br/>
                        Protect your files with scheduled backups to cloud storage and network shares.
                    </p>
                    <div class="hero-features">
                        <div class="feature">
                            <span class="feature-icon">üìÅ</span>
                            <span>Multiple Storage Providers</span>
                        </div>
                        <div class="feature">
                            <span class="feature-icon">‚è∞</span>
                            <span>Scheduled Backups</span>
                        </div>
                        <div class="feature">
                            <span class="feature-icon">üîÑ</span>
                            <span>Sync & Copy Modes</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="auth-container">
                <div class="auth-tabs">
                    <button class="auth-tab @(_activeTab == "login" ? "active" : "")" @onclick="@(() => _activeTab = "login")">
                        Login
                    </button>
                    <button class="auth-tab @(_activeTab == "register" ? "active" : "")" @onclick="@(() => _activeTab = "register")">
                        Register
                    </button>
                </div>
                
                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <div class="alert alert-danger mb-3">@_errorMessage</div>
                }
                
                @if (!string.IsNullOrEmpty(_successMessage))
                {
                    <div class="alert alert-success mb-3">@_successMessage</div>
                }
                
                @if (_activeTab == "login")
                {
                    <EditForm Model="@_loginModel" OnValidSubmit="@HandleLogin" FormName="LoginForm" class="auth-form">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email address</label>
                            <InputText id="loginEmail" @bind-Value="_loginModel.Email" class="form-control" placeholder="you@example.com" />
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <InputText id="loginPassword" @bind-Value="_loginModel.Password" class="form-control" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                        </div>
                        <button type="submit" class="btn btn-primary w-100" disabled="@_isLoading">
                            @if (_isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            Sign In
                        </button>
                    </EditForm>
                }
                else
                {
                    <EditForm Model="@_registerModel" OnValidSubmit="@HandleRegister" FormName="RegisterForm" class="auth-form">
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email address</label>
                            <InputText id="registerEmail" @bind-Value="_registerModel.Email" class="form-control" placeholder="you@example.com" />
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Password</label>
                            <InputText id="registerPassword" @bind-Value="_registerModel.Password" class="form-control" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                            <small class="form-text text-muted">At least 6 characters with uppercase, lowercase, and a number.</small>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm Password</label>
                            <InputText id="confirmPassword" @bind-Value="_registerModel.ConfirmPassword" class="form-control" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                        </div>
                        <button type="submit" class="btn btn-success w-100" disabled="@_isLoading">
                            @if (_isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            Create Account
                        </button>
                    </EditForm>
                }
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private string _activeTab = "login";
    private string? _errorMessage;
    private string? _successMessage;
    private bool _isLoading = false;

    [SupplyParameterFromForm(FormName = "LoginForm")]
    private LoginModel _loginModel { get; set; } = new();

    [SupplyParameterFromForm(FormName = "RegisterForm")]
    private RegisterModel _registerModel { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        // Check if user is already authenticated and redirect to dashboard
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            Navigation.NavigateTo($"{BasePath.Value}/backer/", forceLoad: true);
        }
    }

    private async Task HandleLogin()
    {
        _errorMessage = null;
        _successMessage = null;
        _isLoading = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var loginRequest = new LoginRequest
            {
                Email = _loginModel.Email,
                Password = _loginModel.Password,
                TwoFactorCode = "false",
                TwoFactorRecoveryCode = "false"
            };

            var result = await IdentityApiService.LoginUserAsync(loginRequest, CancellationToken.None);

            if (result.Result is Ok<AccessTokenResponse> okResult)
            {
                var claims = new List<Claim>
                {
                    new Claim(ClaimTypes.Name, _loginModel.Email),
                };

                var identity = new ClaimsIdentity(claims, "Cookies");
                var principal = new ClaimsPrincipal(identity);
                await HttpContextAccessor.HttpContext!.SignInAsync("Cookies", principal);

                // Get token
                var tokenResult = await IdentityApiService.TokenAsync(loginRequest, CancellationToken.None);
                if (tokenResult.Result is Ok<AccessTokenResponse> okTokenResult)
                {
                    var token = okTokenResult.Value!.AccessToken;
                    HttpContextAccessor.HttpContext!.Response.Cookies.Append("access_token", token, new CookieOptions
                    {
                        HttpOnly = true,
                        Secure = true,
                        SameSite = SameSiteMode.Strict
                    });
                }

                Navigation.NavigateTo($"{BasePath.Value}/backer/", forceLoad: true);
            }
            else
            {
                _errorMessage = "Invalid email or password. Please try again.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Login failed: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task HandleRegister()
    {
        _errorMessage = null;
        _successMessage = null;
        _isLoading = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            if (_registerModel.Password != _registerModel.ConfirmPassword)
            {
                _errorMessage = "Passwords do not match.";
                return;
            }

            var registerRequest = new RegisterRequest
            {
                Email = _registerModel.Email,
                Password = _registerModel.Password
            };

            var result = await IdentityApiService.RegisterUserAsync(registerRequest, CancellationToken.None);

            if (result.Result is Ok)
            {
                _successMessage = "Account created successfully! You can now sign in.";
                _activeTab = "login";
                _loginModel.Email = _registerModel.Email;
                _registerModel = new RegisterModel();
            }
            else if (result.Result is ValidationProblem validationProblem)
            {
                var errors = validationProblem.ProblemDetails.Errors
                    .SelectMany(kvp => kvp.Value)
                    .ToList();
                _errorMessage = string.Join(" ", errors);
            }
            else
            {
                _errorMessage = "Registration failed. Please try again.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Registration failed: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    public class LoginModel
    {
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
    }

    public class RegisterModel
    {
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
        public string ConfirmPassword { get; set; } = "";
    }
}
