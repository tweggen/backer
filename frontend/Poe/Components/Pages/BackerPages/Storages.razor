@page "/backer/storages"
@using Hannibal.Client
@using Hannibal.Models
@using Microsoft.AspNetCore.Identity
@using Poe.Services
@inject IHannibalServiceClient HigginsServiceClient
@inject NavigationManager Navigation
@inject Tools.AppBasePath BasePath
@inject AuthState AuthState
@implements IDisposable
@rendermode InteractiveServer

<h3>Storages</h3>

<div class="alert alert-info mb-4" role="alert">
    <h5 class="alert-heading"><span class="me-2">üíæ</span>Storage Connections</h5>
    <p class="mb-2">
        Storages represent your connected cloud accounts or network server credentials. Each Storage defines <strong>how to connect</strong> to a server or cloud account.
    </p>
    <hr>
    <p class="mb-0"><strong>How to use:</strong></p>
    <ul class="mb-0 mt-2">
        <li><strong>Cloud Storage</strong> (OneDrive, Dropbox, Google Drive) ‚Äî Create a storage entry with your email, then click "Authenticate" to connect your account via OAuth.</li>
        <li><strong>Network Shares</strong> (SMB/CIFS) ‚Äî Create one Storage entry per server + username combination. The actual share names and folder paths are specified later when creating Endpoints.</li>
        <li><strong>Local Storage</strong> ‚Äî Access folders directly on the backup agent's machine.</li>
        <li><strong>Networks</strong> ‚Äî Optionally specify which networks this storage is available on (useful for SMB shares only accessible from certain locations).</li>
    </ul>
    <hr>
    <p class="mb-0"><small><strong>üí° Tip for SMB:</strong> If you have multiple shares on the same server that require <em>different</em> login credentials, create a separate Storage entry for each username/password combination. The share name (e.g., "DATA", "Backup") and path (e.g., "Documents/Photos") are configured in <strong>Endpoints</strong>, not here.</small></p>
</div>

@if (_listStorages == null)
{
    <p><em>Loading storages...</em></p>
}
else
{
    <table class="table">
        <thead>
        <tr>
            <th>&nbsp;</th>
            <th title="Storage provider type (cloud service or protocol)">Technology</th>
            <th title="Unique identifier for this storage connection">Name</th>
            <th title="Server address for SMB, or root path for cloud storage">Host / Path</th>
            <th title="Username for SMB, or email for cloud services">Account</th>
            <th title="Networks where this storage is accessible (empty = all networks)">Networks</th>
            <th title="Connection status - whether the storage is properly configured and authenticated">Status</th>
            <th>&nbsp;</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var sto in _listStorages)
        {
            @if (_editingStorageId == sto.Id)
            {
                @* === EDIT MODE === *@
                <tr>
                    <td>&nbsp;</td>
                    <td>@sto.Technology</td>
                    @if (IsCredentialBased(sto.Technology))
                    {
                        <td><InputText id="urischema" @bind-Value="_editingStorage.UriSchema" class="form-control" placeholder="e.g., nas_admin" title="Unique identifier for this storage connection (cannot be changed after endpoints are created)"/></td>
                        <td><InputText id="host" @bind-Value="_editingStorage.Host" class="form-control" placeholder="hostname or IP" title="Server hostname or IP address (e.g., fileserver.local, 192.168.1.50)"/></td>
                        <td><InputText id="username" @bind-Value="_editingStorage.Username" class="form-control" placeholder="username" title="Your login username for this server"/></td>
                    }
                    else
                    {
                        <td><InputText id="urischeme" @bind-Value="_editingStorage.UriSchema" class="form-control" title="Root path within your cloud storage (leave empty for root)"/></td>
                        <td>‚Äî</td>
                        <td><InputText id="useremail" @bind-Value="_editingStorage.OAuth2Email" class="form-control" title="Email address associated with your cloud account"/></td>
                    }
                    <td><InputText id="networks" @bind-Value="_editingStorage.Networks" class="form-control" title="Comma-separated network names where this storage is accessible (empty = all networks)"/></td>
                    <td>&nbsp;</td>
                    <td>
                        <button @onclick="_onEditStorageSubmit" id="submiteditstorage" class="close" title="Save changes">‚úî</button>
                        <button @onclick="_onEditStorageCancel" class="close" aria-label="cancel" title="Cancel editing">‚ùåÔ∏è</button>
                    </td>
                </tr>
                @if (IsCredentialBased(sto.Technology))
                {
                    <tr>
                        <td colspan="2">&nbsp;</td>
                        <td>
                            <InputText id="edit-password" type="password" @bind-Value="_editingStorage.Password" 
                                       class="form-control" placeholder="password (leave empty to keep current)"
                                       title="Enter new password or leave empty to keep current password"/>
                        </td>
                        <td>
                            <InputText id="edit-domain" @bind-Value="_editingStorage.Domain" 
                                       class="form-control" placeholder="domain (optional)"
                                       title="Windows domain for Active Directory authentication (e.g., CORP, MYDOMAIN)"/>
                        </td>
                        <td>
                            <InputNumber id="edit-port" @bind-Value="_editingStorage.Port" 
                                         class="form-control" placeholder="port"
                                         title="Custom port number (leave empty for default: 445 for SMB)"/>
                        </td>
                        <td colspan="2">&nbsp;</td>
                    </tr>
                }
            }
            else
            {
                @* === VIEW MODE === *@
                <tr>
                    <td><button id="starteditstorage" @onclick="() => _onEdit(sto)" aria-label="edit" title="Edit this storage configuration">‚úè</button></td>
                    <td>@sto.Technology</td>
                    @if (IsCredentialBased(sto.Technology))
                    {
                        <td><strong>@sto.UriSchema</strong></td>
                        <td>@sto.Host@(sto.Port.HasValue ? $":{sto.Port}" : "")</td>
                        <td>@(string.IsNullOrWhiteSpace(sto.Domain) ? sto.Username : $"{sto.Domain}\\{sto.Username}")</td>
                    }
                    else
                    {
                        <td><strong>@sto.UriSchema</strong></td>
                        <td>‚Äî</td>
                        <td>@sto.OAuth2Email</td>
                    }
                    <td>@sto.Networks</td>
                    <td>
                        @if (IsCredentialBased(sto.Technology))
                        {
                            @if (!string.IsNullOrWhiteSpace(sto.Host) && !string.IsNullOrWhiteSpace(sto.Username))
                            {
                                <span class="badge bg-success" title="Server and credentials are configured. The backup agent can connect to this storage.">Configured</span>
                            }
                            else
                            {
                                <span class="badge bg-warning" title="Missing required fields (host or username). Edit this storage to complete the configuration.">Incomplete</span>
                            }
                        }
                        else
                        {
                            @if (!string.IsNullOrWhiteSpace(sto.AccessToken))
                            {
                                <span class="badge bg-success" title="Successfully authenticated with your cloud account. The backup agent can access your files.">Connected</span>
                            }
                            else
                            {
                                <span class="badge bg-warning" title="Click 'Authenticate' to connect your cloud account. You'll be redirected to sign in securely.">Not authenticated</span>
                            }
                        }
                    </td>
                    <td>
                        @if (RequiresOAuth(sto.Technology))
                        {
                            @if (string.IsNullOrWhiteSpace(sto.AccessToken))
                            {
                                <button @onclick="() => _onOAuthConnect(sto)" class="btn btn-sm btn-primary" title="Connect to your cloud account via OAuth - you'll be redirected to sign in">Authenticate...</button>
                            }
                            else
                            {
                                <button @onclick="() => _onOAuthDisconnect(sto)" class="btn btn-sm btn-outline-secondary" title="Remove the connection to your cloud account (you can reconnect later)">Disconnect</button>
                            }
                        }
                        <button @onclick="() => _onDelete(sto)" class="btn btn-sm btn-outline-danger" aria-label="delete" title="Delete this storage and all endpoints using it">üóëÔ∏è</button>
                    </td>
                </tr>
            }
        }
        </tbody>
    </table>

    <h2>Create new storage</h2>
    <div class="row">
        <div class="col-md-6">
            <EditForm method="post"  
                      OnValidSubmit="_addStorage"
                      FormName="create" Enhance
                      EditContext="_editContext">
                <DataAnnotationsValidator/>
                <CustomValidator @ref="_customValidator"/>
                <ValidationSummary class="text-danger"/>
                
                @* Technology Selection *@
                <div class="mb-3">
                    <label for="technology" class="form-label">Technology:</label>
                    <InputSelect id="technology"
                                 class="form-control"
                                 title="Select the type of storage you want to connect. Cloud storages use OAuth authentication, while SMB uses username/password."
                                 @bind-Value="_newStorage.Technology"
                                 @bind-Value:after="_onTechnologyChanged">
                        @foreach (var tech in Technologies.GetTechnologies())
                        {
                            <option value="@tech">@GetTechnologyDisplayName(tech)</option>
                        }
                    </InputSelect>
                    <small class="form-text text-muted">Choose the storage provider or protocol</small>
                    <ValidationMessage For="() => _newStorage.Technology" class="text-danger"/>
                </div>

                @if (IsCredentialBased(_newStorage.Technology))
                {
                    @* === CREDENTIAL-BASED STORAGE (SMB, Local, etc.) === *@
                    <div class="alert alert-info" role="alert">
                        <strong>@GetTechnologyDisplayName(_newStorage.Technology)</strong> uses username/password authentication.
                        <br/><small>Create one Storage per server + login combination. Share names and folder paths are configured in Endpoints.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="host" class="form-label">Host: <span class="text-danger">*</span></label>
                        <InputText id="host"
                                   placeholder="server.local or 192.168.1.100"
                                   class="form-control"
                                   title="The hostname or IP address of the file server. Examples: fileserver.local, nas.home, 192.168.1.50"
                                   @bind-Value="_newStorage.Host"/>
                        <small class="form-text text-muted">Server hostname or IP address where your shares are located</small>
                        <ValidationMessage For="() => _newStorage.Host" class="text-danger"/>
                    </div>
                    
                    <div class="mb-3">
                        <label for="username" class="form-label">Username: <span class="text-danger">*</span></label>
                        <InputText id="username"
                                   placeholder="username"
                                   class="form-control"
                                   title="Your login username for the file server. For domain accounts, enter just the username (domain goes in the Domain field)."
                                   @bind-Value="_newStorage.Username"/>
                        <small class="form-text text-muted">Your account username for this server</small>
                        <ValidationMessage For="() => _newStorage.Username" class="text-danger"/>
                    </div>
                    
                    <div class="mb-3">
                        <label for="password" class="form-label">Password:</label>
                        <InputText id="password"
                                   type="password"
                                   placeholder="password"
                                   class="form-control"
                                   title="Your account password. This is stored securely and used by the backup agent to connect."
                                   @bind-Value="_newStorage.Password"/>
                        <small class="form-text text-muted">Password for authentication (stored securely)</small>
                        <ValidationMessage For="() => _newStorage.Password" class="text-danger"/>
                    </div>
                    
                    <div class="mb-3">
                        <label for="domain" class="form-label">Domain (optional):</label>
                        <InputText id="domain"
                                   placeholder="WORKGROUP or domain name"
                                   class="form-control"
                                   title="For Active Directory environments, enter your Windows domain name. Leave empty for workgroup-based authentication."
                                   @bind-Value="_newStorage.Domain"/>
                        <small class="form-text text-muted">Windows domain for Active Directory authentication (e.g., CORP, MYDOMAIN)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="port" class="form-label">Port (optional):</label>
                        <InputNumber id="port"
                                     class="form-control"
                                     title="Custom port number if your server uses a non-standard port. SMB typically uses port 445."
                                     @bind-Value="_newStorage.Port"/>
                        <small class="form-text text-muted">Leave empty for default (445 for SMB). Only change if your server uses a custom port.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="urischema" class="form-label">Storage Name: <span class="text-danger">*</span></label>
                        <InputText id="urischema"
                                   placeholder="e.g., nas_admin, fileserver_backup"
                                   class="form-control"
                                   title="A unique name to identify this storage connection. Use something descriptive like 'nas_admin' or 'server_guest'. This is NOT the share name."
                                   @bind-Value="_newStorage.UriSchema"/>
                        <small class="form-text text-muted">A unique identifier for this connection (e.g., "nas_admin", "fileserver_backup"). <strong>Not</strong> the share name ‚Äî that goes in Endpoints.</small>
                        <ValidationMessage For="() => _newStorage.UriSchema" class="text-danger"/>
                    </div>
                }
                else if (_newStorage.Technology == "local")
                {
                    @* === LOCAL STORAGE === *@
                    <div class="alert alert-info" role="alert">
                        <strong>Local Storage</strong> accesses files directly on the backup agent's machine. Use this for local drives or mounted volumes.
                    </div>
                    
                    <div class="mb-3">
                        <label for="urischema" class="form-label">Base Path:</label>
                        <InputText id="urischema"
                                   placeholder="/path/to/folder or C:\path\to\folder"
                                   class="form-control"
                                   title="The root folder path on the backup agent's filesystem. Use forward slashes for Linux/Mac, backslashes for Windows."
                                   @bind-Value="_newStorage.UriSchema"/>
                        <small class="form-text text-muted">Base folder path on the agent machine (e.g., /home/user/documents or D:\Backups)</small>
                        <ValidationMessage For="() => _newStorage.UriSchema" class="text-danger"/>
                    </div>
                }
                else
                {
                    @* === OAUTH-BASED STORAGE (OneDrive, Dropbox, Google Drive) === *@
                    <div class="alert alert-info" role="alert">
                        <strong>@GetTechnologyDisplayName(_newStorage.Technology)</strong> uses OAuth authentication. 
                        After creating, click "Authenticate" to securely connect your cloud account without sharing your password.
                    </div>
                    
                    <div class="mb-3">
                        <label for="urischema" class="form-label">Root Path (optional):</label>
                        <InputText id="urischema"
                                   placeholder="/Backups"
                                   class="form-control"
                                   title="Optional: Specify a default folder path within your cloud storage. Leave empty to start from the root."
                                   @bind-Value="_newStorage.UriSchema"/>
                        <small class="form-text text-muted">Default folder path in your cloud storage (leave empty for root)</small>
                        <ValidationMessage For="() => _newStorage.UriSchema" class="text-danger"/>
                    </div>
                    
                    <div class="mb-3">
                        <label for="useremail" class="form-label">Account Email: <span class="text-danger">*</span></label>
                        <InputText id="useremail"
                                   placeholder="your-email@example.com"
                                   class="form-control"
                                   title="The email address of your cloud storage account. This helps identify which account to authenticate."
                                   @bind-Value="_newStorage.OAuth2Email"/>
                        <small class="form-text text-muted">The email associated with your @GetTechnologyDisplayName(_newStorage.Technology) account</small>
                        <ValidationMessage For="() => _newStorage.OAuth2Email" class="text-danger"/>
                    </div>
                }
                
                @* Common fields *@
                <div class="mb-3">
                    <label for="networks" class="form-label">Networks (optional):</label>
                    <InputText id="networks"
                               placeholder="home, office"
                               class="form-control"
                               title="Restrict this storage to specific networks. The backup agent will only use this storage when connected to one of these networks. Leave empty to allow access from any network."
                               @bind-Value="_newStorage.Networks"/>
                    <small class="form-text text-muted">Comma-separated network names (e.g., "home, office"). Leave empty to allow access from anywhere.</small>
                </div>
                
                <button type="submit" class="btn btn-primary">Create Storage</button>
            </EditForm>
        </div>
    </div>
}


@code {
    
    private CustomValidator _customValidator;
    private EditContext _editContext;

    private List<Storage>? _listStorages = null;
    private IdentityUser? _user = null;

    private int _editingStorageId { get; set; } = -1;

    [SupplyParameterFromForm] private Storage? _editingStorage { get; set; } = new() { Id = -1 };

    [SupplyParameterFromForm] private Storage? _newStorage { get; set; } = null;

    /// <summary>
    /// Technologies that use OAuth authentication
    /// </summary>
    private static readonly HashSet<string> OAuthTechnologies = new(StringComparer.OrdinalIgnoreCase)
    {
        "onedrive",
        "dropbox", 
        "googledrive"
    };

    /// <summary>
    /// Technologies that use credential-based authentication (username/password)
    /// </summary>
    private static readonly HashSet<string> CredentialTechnologies = new(StringComparer.OrdinalIgnoreCase)
    {
        "smb"
    };

    /// <summary>
    /// Check if a technology requires OAuth authentication
    /// </summary>
    private static bool RequiresOAuth(string? technology)
    {
        return !string.IsNullOrWhiteSpace(technology) && OAuthTechnologies.Contains(technology);
    }

    /// <summary>
    /// Check if a technology uses credential-based authentication
    /// </summary>
    private static bool IsCredentialBased(string? technology)
    {
        return !string.IsNullOrWhiteSpace(technology) && CredentialTechnologies.Contains(technology);
    }

    /// <summary>
    /// Get a user-friendly display name for a technology
    /// </summary>
    private static string GetTechnologyDisplayName(string? technology)
    {
        return technology?.ToLowerInvariant() switch
        {
            "onedrive" => "OneDrive",
            "dropbox" => "Dropbox",
            "googledrive" => "Google Drive",
            "smb" => "SMB/CIFS Network Share",
            "local" => "Local Filesystem",
            _ => technology ?? "Unknown"
        };
    }

    /// <summary>
    /// Called when technology selection changes to reset irrelevant fields
    /// </summary>
    private void _onTechnologyChanged()
    {
        if (_newStorage == null) return;
        
        // Clear fields that don't apply to the new technology
        if (IsCredentialBased(_newStorage.Technology))
        {
            // Clear OAuth fields
            _newStorage.OAuth2Email = "";
            _newStorage.AccessToken = "";
            _newStorage.RefreshToken = "";
            _newStorage.ClientId = "";
            _newStorage.ClientSecret = "";
        }
        else
        {
            // Clear credential fields
            _newStorage.Host = "";
            _newStorage.Username = "";
            _newStorage.Password = "";
            _newStorage.Domain = "";
            _newStorage.Port = null;
        }
    }


    public void Dispose()
    {
        if (_editContext != null)
        {
            _editContext.OnValidationRequested -= _onValidateNewStorage;
        }
    }


    private async Task _onOAuthConnect(Storage? sto)
    {
        if (null == sto)
        {
            return;
        }
        try
        {
            TriggerOAuth2Result result = await HigginsServiceClient.TriggerOAuth2Async(
                new OAuth2Params()
                {
                    UserLogin = sto.OAuth2Email,
                    Provider = sto.Technology,
                    AfterAuthUri = Navigation.Uri
                },
                CancellationToken.None);
            Navigation.NavigateTo(result.RedirectUrl, forceLoad: true);
        }
        catch (Exception e)
        {
            Console.WriteLine($"OAuth connect error: {e}");
        }
    }

    
    private async Task _onOAuthDisconnect(Storage? sto)
    {
        if (null == sto)
        {
            return;
        }
        try
        {
            sto.AccessToken = "";
            sto.RefreshToken = "";
            await HigginsServiceClient.UpdateStorageAsync(sto.Id, sto, CancellationToken.None);
            await InvokeAsync(StateHasChanged);      
        }
        catch (Exception e)
        {
            Console.WriteLine($"OAuth disconnect error: {e}");
        }
    }

    
    private async Task _onEdit(Storage? sto)
    {
        if (sto != null)
        {
            _editingStorageId = sto.Id;
            // Create a copy to avoid modifying the original until submit
            _editingStorage = new Storage(sto);
            // Clear password so user has to re-enter if they want to change it
            if (IsCredentialBased(sto.Technology))
            {
                _editingStorage.Password = "";
            }
        }
        else
        {
            _editingStorageId = -1;
            _editingStorage = new() { Id = -1 };
        }
        
        await InvokeAsync(StateHasChanged);      
    }


    private async Task _onDelete(Storage sto)
    {
        await HigginsServiceClient.DeleteStorageAsync(sto.Id, CancellationToken.None);
        _listStorages = new List<Storage>(
            await HigginsServiceClient.GetStoragesAsync(CancellationToken.None)
        );
        await InvokeAsync(StateHasChanged);      
    }
    
    
    private async Task _onEditStorageCancel()
    {
        _editingStorageId = -1;
        _editingStorage = new() { Id = -1 };
        await InvokeAsync(StateHasChanged);      
    }


    private async Task _onEditStorageSubmit()
    {
        if (_editingStorage != null && _editingStorageId > 0)
        {
            // Find the original storage to preserve password if not changed
            var originalStorage = _listStorages?.FirstOrDefault(s => s.Id == _editingStorageId);
            if (originalStorage != null && IsCredentialBased(_editingStorage.Technology))
            {
                // If password field is empty, preserve the original password
                if (string.IsNullOrWhiteSpace(_editingStorage.Password))
                {
                    _editingStorage.Password = originalStorage.Password;
                }
            }
            
            await HigginsServiceClient.UpdateStorageAsync(_editingStorage.Id, _editingStorage, CancellationToken.None);
            
            // Refresh the list
            _listStorages = new List<Storage>(
                await HigginsServiceClient.GetStoragesAsync(CancellationToken.None)
            );
        }

        _editingStorageId = -1;
        _editingStorage = new() { Id = -1 };
        await InvokeAsync(StateHasChanged);
    }


    private void _onValidateNewStorage(object sender, ValidationRequestedEventArgs ve)
    {
        try
        {
            _customValidator.Clear();

            if (null == _newStorage)
            {
                return;
            }

            if (string.IsNullOrWhiteSpace(_newStorage.Technology))
            {
                _customValidator.AddError(nameof(_newStorage.Technology), "Please select a technology");
                return;
            }

            if (IsCredentialBased(_newStorage.Technology))
            {
                // Validate credential-based storage (SMB)
                if (string.IsNullOrWhiteSpace(_newStorage.Host))
                {
                    _customValidator.AddError(nameof(_newStorage.Host), "Host is required for SMB storage");
                }
                
                if (string.IsNullOrWhiteSpace(_newStorage.Username))
                {
                    _customValidator.AddError(nameof(_newStorage.Username), "Username is required for SMB storage");
                }
                
                if (string.IsNullOrWhiteSpace(_newStorage.UriSchema))
                {
                    _customValidator.AddError(nameof(_newStorage.UriSchema), "Storage Name is required - use a unique identifier like 'nas_admin' or 'server_backup'");
                }
                
                // Check for duplicate: same storage name
                if (_listStorages != null && !string.IsNullOrWhiteSpace(_newStorage.UriSchema))
                {
                    var duplicateName = _listStorages.FirstOrDefault(s => 
                        s.UriSchema.Equals(_newStorage.UriSchema.Trim(), StringComparison.OrdinalIgnoreCase));
                    
                    if (duplicateName != null)
                    {
                        _customValidator.AddError(nameof(_newStorage.UriSchema), 
                            "A storage with this name already exists. Please choose a unique name.");
                    }
                }
                
                // Check for duplicate: same technology + host + username
                if (_listStorages != null && !string.IsNullOrWhiteSpace(_newStorage.Host))
                {
                    var duplicate = _listStorages.FirstOrDefault(s => 
                        s.Technology.Equals(_newStorage.Technology, StringComparison.OrdinalIgnoreCase) &&
                        s.Host.Equals(_newStorage.Host.Trim(), StringComparison.OrdinalIgnoreCase) &&
                        s.Username.Equals(_newStorage.Username?.Trim() ?? "", StringComparison.OrdinalIgnoreCase));
                    
                    if (duplicate != null)
                    {
                        _customValidator.AddError(nameof(_newStorage.Host), 
                            "A storage with this host and username already exists");
                    }
                }
            }
            else if (_newStorage.Technology == "local")
            {
                // Validate local storage
                if (string.IsNullOrWhiteSpace(_newStorage.UriSchema))
                {
                    _customValidator.AddError(nameof(_newStorage.UriSchema), "Base path is required for local storage");
                }
            }
            else if (RequiresOAuth(_newStorage.Technology))
            {
                // Validate OAuth-based storage
                if (string.IsNullOrWhiteSpace(_newStorage.OAuth2Email))
                {
                    _customValidator.AddError(nameof(_newStorage.OAuth2Email), 
                        "Please specify an account email for OAuth authentication");
                }

                // Check for duplicate: same technology + email
                if (_listStorages != null && !string.IsNullOrWhiteSpace(_newStorage.OAuth2Email))
                {
                    var duplicate = _listStorages.FirstOrDefault(s => 
                        s.Technology.Equals(_newStorage.Technology, StringComparison.OrdinalIgnoreCase) &&
                        s.OAuth2Email.Equals(_newStorage.OAuth2Email.Trim(), StringComparison.OrdinalIgnoreCase));
                    
                    if (duplicate != null)
                    {
                        _customValidator.AddError(nameof(_newStorage.OAuth2Email), 
                            "A storage with this email and technology already exists");
                    }
                }
            }
        }
        catch (Exception e)
        {
            Console.WriteLine($"Validation error: {e}");
        }
    }


    private async Task _addStorage()
    {
        await HigginsServiceClient.CreateStorageAsync(_newStorage, CancellationToken.None);
        _listStorages = new List<Storage>(
            await HigginsServiceClient.GetStoragesAsync(CancellationToken.None)
        );
        _newStorage = Storage.Default();
        await InvokeAsync(StateHasChanged);      
    }
    
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (AuthState.ReadResetRedirectToLogin())
        {
            await InvokeAsync(() =>
            {
                Task.Delay(200);
                Navigation.NavigateTo("/login");
            });
        }
    }


    protected override async Task OnInitializedAsync()
    {
        try
        {
            _user = await HigginsServiceClient.GetUserAsync(-1, CancellationToken.None);
            if (null == _user)
            {
                Navigation.NavigateTo($"{BasePath.Value}/login");
            }

            _listStorages = new List<Storage>(
                await HigginsServiceClient.GetStoragesAsync(CancellationToken.None)
            );

            _newStorage = Storage.Default();

            _editContext = new EditContext(_newStorage);
            _editContext.OnValidationRequested += _onValidateNewStorage;
        }
        catch (Exception e)
        {
            Console.WriteLine($"Init error: {e}");
        }
    }

}
