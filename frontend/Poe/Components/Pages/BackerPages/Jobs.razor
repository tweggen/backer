@page "/backer/jobs"
@using Hannibal.Client
@using Hannibal.Client.Configuration
@using Hannibal.Models
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Options
@using Poe.Services
@using Tools
@rendermode InteractiveServer

@inject IHannibalServiceClient HigginsServiceClient
@inject IHannibalServiceClient HannibalServiceClient
@inject AuthState AuthState
@inject NavigationManager Navigation
@inject Tools.AppBasePath BasePath
@inject IOptions<HannibalServiceClientOptions> HannibalServiceClientOptions
@inject ITokenProvider TokenProvider  

<h3>Jobs</h3>

@if (listJobs == null)
{
    <p><em>Loading jobs...</em></p>
}
else
{
    <table class="table">
        <thead>
        <tr>
            <th>ID</th>
            <th>State</th>
            <th>SourceEndpoint</th>
            <th>DestinationEndpoint</th>
            <th>StartFrom</th>
            <th>Endby</th>
            <th>Last reported</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var job in listJobs)
        {
            <tr>
                <td>@job.Id</td>
                <td>@job.State</td>
                <td>@job.SourceEndpoint.Name</td>
                <td>@job.DestinationEndpoint.Name</td>
                <td>@job.StartFrom</td>
                <td>@job.EndBy</td>
                <td>@job.LastReported</td>
            </tr>
        }
        </tbody>
    </table>
    <button @onclick="_onClearJobs" id="clearJobs">Clear</button>
}

@code {
    private List<Job> listJobs;
    private IdentityUser? _user;
    private HubConnection? hubConnection;

    
    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }


    private async Task _onClearJobs()
    {
        try
        {
            await HannibalServiceClient.DeleteJobsAsync(CancellationToken.None);
            await _loadJobsAsync();
        }
        catch (Exception e)
        {
            
        }
    }

    
    private async Task _loadJobsAsync()
    {
        try
        {
            listJobs = new List<Job>(
                await HannibalServiceClient.GetJobsAsync(
                    new ResultPage() { Offset = 0, Length = 20 },
                    new JobFilter() { MaxState = Job.JobState.DoneSuccess, MinState = Job.JobState.Preparing },
                    CancellationToken.None
                ));
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception e)
        {
            // Handle error
        }
    }
    
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (AuthState.ReadResetRedirectToLogin())
        {
            await InvokeAsync(() =>
            {
                Task.Delay(200);
                Navigation.NavigateTo("/login");
            });
        }
    }

    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            _user = await HannibalServiceClient.GetUserAsync(-1, CancellationToken.None);
            if (null == _user)
            {
                AuthState.TriggerRedirectToLogin();
                return;
            }

            await _loadJobsAsync();

            await _setupSignalRConnection();
        }
        catch (Exception e)
        {
            // TXWTODO: Catch 401 ?
        }
    }
    

    private async Task _setupSignalRConnection()
    {
        try
        {
            var options = HannibalServiceClientOptions.Value;
            hubConnection = new HubConnectionBuilder()
                .WithUrl($"{options.BaseUrl}/hannibal", httpOptions =>
                {
                    httpOptions.AccessTokenProvider = async () => await TokenProvider.GetToken();
                })
                .WithAutomaticReconnect()
                .Build();

            // Listen for job updates
            hubConnection.On<int, string>("JobUpdated", async (jobId, newState) =>
            {
                // Reload the jobs list when any job is updated
                await _loadJobsAsync();
            });
            
            // Also keep the old "NewJobAvailable" handler for backward compatibility
            hubConnection.On("NewJobAvailable", async () =>
            {
                await _loadJobsAsync();
            });

            await hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            // Log the error - connection failed
            Console.WriteLine($"SignalR connection failed: {ex.Message}");
        }
    }
}
