@page "/backer/account"
@using Hannibal.Client
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore.Metadata.Internal
@using Poe.Services
@inject IHttpContextAccessor HttpContextAccessor
@inject IJSRuntime JsRuntime
@inject IIdentityApiService IdentityApiService
@inject NavigationManager Navigation
@inject IHannibalServiceClient HannibalServiceClient
@inject Tools.AppBasePath BasePath
@inject AuthState AuthState

@rendermode InteractiveServer
@attribute [Authorize]
<h3>Account Settings</h3>

<div class="alert alert-info mb-4" role="alert">
    <h5 class="alert-heading"><span class="me-2">üë§</span>Your Account</h5>
    <p class="mb-2">
        Manage your Backer account settings here. You can view your account details or permanently delete your account.
    </p>
    <hr>
    <p class="mb-0"><strong>Important:</strong></p>
    <ul class="mb-0 mt-2">
        <li><strong>Logout</strong> ‚Äî End your current session. You can log back in anytime.</li>
        <li><strong>Delete Account</strong> ‚Äî Permanently removes your account and all associated data (storages, endpoints, rules, job history). This action cannot be undone!</li>
    </ul>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Account Information</h5>
    </div>
    <div class="card-body">
        <table class="table table-borderless mb-0">
            <tbody>
                <tr>
                    <td class="fw-bold" style="width: 150px;" title="Your registered email address used for login">Email Address</td>
                    <td>@_user?.Email</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Session</h5>
    </div>
    <div class="card-body">
        <p class="text-muted mb-3">End your current session. You'll need to log in again to access Backer.</p>
        <a href="/logout" class="btn btn-outline-primary" title="Sign out of your current session">Logout</a>
    </div>
</div>

<div class="card border-danger">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0">‚ö†Ô∏è Danger Zone</h5>
    </div>
    <div class="card-body">
        <p class="text-muted mb-2">Permanently delete your account and all associated data.</p>
        <p class="text-danger mb-3"><strong>Warning:</strong> This will delete all your storages, endpoints, backup rules, and job history. This action cannot be undone!</p>
        <button @onclick="_onDeleteAccount" 
                class="btn btn-danger" 
                title="Permanently delete your account and all data - this cannot be undone!">Delete Account</button>
    </div>
</div>

@code {
    private IdentityUser? _user = null;

    private async void _onDeleteAccount()
    {
        bool confirmed = await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure?");
        if (!confirmed)
        {
            return;
        }

        await HttpContextAccessor.HttpContext!.SignOutAsync("Cookies");
        var result = await IdentityApiService.DeleteUserAsync(_user!.Id, CancellationToken.None);
        if (!result)
        {
            return;
        }
        else
        {
            Navigation.NavigateTo($"{BasePath.Value}/login", forceLoad: true);
        }
    }
    
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (AuthState.ReadResetRedirectToLogin())
        {
            await InvokeAsync(() =>
            {
                Task.Delay(200);
                Navigation.NavigateTo("/login");
            });
        }
    }


    protected override async Task OnInitializedAsync()
    {
        try
        {
            _user = await HannibalServiceClient.GetUserAsync(-1, CancellationToken.None);
            if (null == _user)
            {
                AuthState.TriggerRedirectToLogin();
            }
        }
        catch (Exception e)
        {
            // TXWTODO: Catch 401 ?
        }
    }

}