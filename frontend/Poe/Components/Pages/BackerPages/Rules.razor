@page "/backer/rules"
@using Hannibal.Client
@using Hannibal.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Poe.Services
@inject IHannibalServiceClient HannibalServiceClient
@inject NavigationManager Navigation
@inject Tools.AppBasePath BasePath
@inject AuthState AuthState
@implements IDisposable
@rendermode InteractiveServer
@attribute [Authorize]


<h3>Backup Rules</h3>

<div class="alert alert-info mb-4" role="alert">
    <p class="mb-0">
        Rules define your backup schedules. Each rule specifies what to backup (source), where to backup (destination), and when to run.
        <button type="button" class="info-toggle" @onclick="() => _showRulesDetails = !_showRulesDetails">@(_showRulesDetails ? "less details..." : "more details...")</button>
    </p>
    @if (_showRulesDetails)
    {
        <hr>
        <p class="mb-0"><strong>How rules work:</strong></p>
        <ul class="mb-0 mt-2">
            <li><strong>Source Endpoint</strong> ‚Äî The folder you want to backup (where your files are).</li>
            <li><strong>Destination Endpoint</strong> ‚Äî Where the backup should be stored.</li>
            <li><strong>Operation</strong> ‚Äî <em>Copy</em> adds new/changed files; <em>Sync</em> also removes files deleted from source.</li>
            <li><strong>Max Destination Age</strong> ‚Äî How old the backup can get before a new backup is triggered (in seconds).</li>
            <li><strong>Min Retry Time</strong> ‚Äî Minimum wait time between retry attempts if a backup fails (in seconds).</li>
            <li><strong>Daily Trigger Time</strong> ‚Äî Preferred time of day to run backups (seconds from midnight, e.g., 7200 = 2:00 AM).</li>
        </ul>
        <p class="mt-2 mb-0"><em>Tip: Set Max Destination Age to 86400 (24 hours) for daily backups, or 3600 (1 hour) for hourly backups.</em></p>
    }
</div>

@if (_listRules == null)
{
    <p><em>Loading rules...</em></p>
}
else
{
    @* === CARD VIEW (used for both mobile and desktop) === *@
    <div class="rules-card-list">
        @foreach (var ru in _listRules)
        {
            @if (_editRuleId == ru.Id && _listEndpoints != null)
            {
                @* Edit mode card *@
                <div class="rule-card rule-card-edit">
                    <div class="form-group">
                        <label>Name</label>
                        <InputText class="form-control" @bind-Value="_editRule.Name" placeholder="Rule name"/>
                    </div>
                    <div class="form-group">
                        <label>Source (from)</label>
                        <InputSelect class="form-control"
                                     @bind-Value="_editSourceEndpointId"
                                     @bind-Value:after="_onEditSourceEndpointChanged">
                            @foreach (var ep in _listEndpoints)
                            {
                                <option value="@ep.Id">@ep.Name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="form-group">
                        <label>Operation</label>
                        <InputSelect TValue="Rule.RuleOperation" class="form-control" @bind-Value="_editRule.Operation">
                            @foreach (var op in Enum.GetValues(typeof(Rule.RuleOperation)))
                            {
                                <option value="@op">@op</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="form-group">
                        <label>Destination (to)</label>
                        <InputSelect class="form-control"
                                     @bind-Value="_editDestinationEndpointId"
                                     @bind-Value:after="_onEditDestinationEndpointChanged">
                            @foreach (var ep in _listEndpoints)
                            {
                                <option value="@ep.Id">@ep.Name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="edit-row">
                        <div class="form-group">
                            <label>Max Age (s)</label>
                            <InputNumber class="form-control" @bind-Value="_editMaxDestAge"/>
                        </div>
                        <div class="form-group">
                            <label>Retry (s)</label>
                            <InputNumber class="form-control" @bind-Value="_editMinRetryTime"/>
                        </div>
                        <div class="form-group">
                            <label>Daily (s)</label>
                            <InputNumber class="form-control" @bind-Value="_editDailyTriggerTime"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Comment</label>
                        <InputText class="form-control" @bind-Value="_editRule.Comment" placeholder="Optional notes"/>
                    </div>
                    <div class="rule-card-edit-actions">
                        <button class="btn-cancel" @onclick="_onEditRuleCancel">Cancel</button>
                        <button class="btn-save" @onclick="_onEditRuleSubmit">Save</button>
                    </div>
                </div>
            }
            else
            {
                @* View mode card *@
                <div class="rule-card">
                    <div class="rule-card-header">
                        <h4 class="rule-card-title">üìã @ru.Name</h4>
                        <button class="btn-edit" @onclick="() => _onEdit(ru)" title="Edit">‚úèÔ∏è</button>
                    </div>
                    <div class="rule-card-main">
                        <div class="rule-card-endpoints">
                            <span class="endpoint">@ru.SourceEndpoint.Name</span>
                            <span class="arrow">‚Üí</span>
                            <span class="endpoint">@ru.DestinationEndpoint.Name</span>
                        </div>
                        <div class="rule-card-operation">
                            <strong>@ru.Operation.ToString()</strong>
                        </div>
                    </div>
                    <div class="rule-card-right">
                        <button class="btn-delete" @onclick="() => _onDelete(ru)" title="Delete">üóëÔ∏è</button>
                    </div>
                    <div class="rule-card-footer">
                        <div class="rule-card-status">
                            @{
                                var cardStatus = _ruleStates.TryGetValue(ru.Id, out var cardRs) 
                                    ? (cardRs.ExpiredAfter > DateTime.UtcNow ? "Active" : "Expired") 
                                    : "Unknown";
                                var cardBadgeClass = cardStatus == "Active" ? "bg-success" : (cardStatus == "Expired" ? "bg-warning" : "bg-secondary");
                            }
                            <span class="badge @cardBadgeClass">@cardStatus</span>
                        </div>
                        <div class="rule-card-stats">
                            <span>Age: @FormatDuration(ru.MaxDestinationAge)</span>
                            <span>Retry: @FormatDuration(ru.MinRetryTime)</span>
                            <span>Daily: @FormatTimeOfDay(ru.DailyTriggerTime)</span>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(ru.Comment))
                        {
                            <div class="rule-card-comment">@ru.Comment</div>
                        }
                    </div>
                </div>
            }
        }
    </div>
    
    <button @onclick="() => _onFlush()" class="btn btn-outline-warning btn-sm mt-3" title="Force the backup agent to re-evaluate all rules immediately. Use this after making changes to trigger backups sooner.">üîÑ Re-evaluate Rules</button>
}

@if (_listEndpoints == null)
{
    <p><em>Loading endpoints</em></p>
} else if (!_listEndpoints.Any())
{
    <p>No endpoints defined. Please define endpoints before using them in rules.</p>
}
else
{
    @* === COLLAPSIBLE CREATE FORM === *@
    <div class="create-section mt-4">
        @if (!_showCreateForm)
        {
            <button type="button" class="btn btn-outline-primary" @onclick="_onShowCreateForm">
                ‚ûï Create new rule...
            </button>
        }
        else
        {
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Create new rule</h5>
                    <button type="button" class="btn-close" @onclick="_onCancelCreate" title="Cancel"></button>
                </div>
                <div class="card-body">
                    <EditForm method="post" Model="_newRule" OnValidSubmit="_onNewRuleSubmit" FormName="create" Enhance>
                        <DataAnnotationsValidator/>
                        <ValidationSummary class="text-danger"/>
                        <fieldset disabled="@_isCreating">
                            <div class="mb-3">
                                <label for="name" class="form-label">Rule Name: <span class="text-danger">*</span></label>
                                <InputText id="name"
                                           placeholder="Daily Documents Backup"
                                           class="form-control"
                                           @bind-Value="_newRule.Name" />
                                <small class="form-text text-muted">A friendly name to identify this backup rule</small>
                            </div>
                            <div class="mb-3">
                                <label for="sourceEndpoint" class="form-label">Source Endpoint (backup from): <span class="text-danger">*</span></label>
                                <InputSelect id="sourceEndpoint"
                                             class="form-control"
                                             @bind-Value="_newSourceEndpointId" 
                                             @bind-Value:after="_onNewSourceEndpointChanged">
                                    @foreach (var ep in _listEndpoints)
                                    {
                                        <option value="@ep.Id">@ep.Name</option>
                                    }
                                </InputSelect>
                                <small class="form-text text-muted">Where your original files are</small>
                            </div>
                            <div class="mb-3">
                                <label for="operation" class="form-label">Operation: <span class="text-danger">*</span></label>
                                <InputSelect TValue="Rule.RuleOperation" id="operation" class="form-control" @bind-Value="_newRule.Operation">
                                    @foreach (var op in Enum.GetValues(typeof(Rule.RuleOperation)))
                                    {
                                        <option value="@op">@op</option>
                                    }
                                </InputSelect>
                                <small class="form-text text-muted"><strong>Copy</strong> = add/update only; <strong>Sync</strong> = mirror exactly</small>
                            </div>
                            <div class="mb-3">
                                <label for="destinationEndpoint" class="form-label">Destination Endpoint (backup to): <span class="text-danger">*</span></label>
                                <InputSelect id="destinationEndpoint"
                                             class="form-control"
                                             @bind-Value="_newDestinationEndpointId"
                                             @bind-Value:after="_onNewDestinationEndpointChanged">
                                    @foreach (var ep in _listEndpoints)
                                    {
                                        <option value="@ep.Id">@ep.Name</option>
                                    }
                                </InputSelect>
                                <small class="form-text text-muted">Where backups will be stored</small>
                            </div>
                            
                            <h6 class="mt-4 mb-3">Scheduling Options</h6>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="maxDestAge" class="form-label">Max Age (seconds):</label>
                                    <InputNumber id="maxDestAge" class="form-control" @bind-Value="_newMaxDestAge"/>
                                    <small class="form-text text-muted">86400 = daily</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="minRetryTime" class="form-label">Retry Time (seconds):</label>
                                    <InputNumber id="minRetryTime" class="form-control" @bind-Value="_newMinRetryTime"/>
                                    <small class="form-text text-muted">Wait after failure</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="dailyTriggerTime" class="form-label">Daily Time (seconds):</label>
                                    <InputNumber id="dailyTriggerTime" class="form-control" @bind-Value="_newDailyTriggerTime"/>
                                    <small class="form-text text-muted">7200 = 2:00 AM</small>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="comment" class="form-label">Comment (optional):</label>
                                <InputText id="comment" placeholder="Optional notes" class="form-control" @bind-Value="_newRule.Comment" />
                            </div>
                        </fieldset>
                        <div class="d-flex gap-2 justify-content-end">
                            <button type="button" class="btn btn-secondary" @onclick="_onCancelCreate" disabled="@_isCreating">Cancel</button>
                            <button type="submit" class="btn btn-primary" disabled="@_isCreating">
                                @if (_isCreating)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                }
                                Create Rule
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        }
    </div>
}


@code {
    private List<Hannibal.Models.Rule>? _listRules = null;
    private Dictionary<int, RuleState> _ruleStates = new();
    private List<Hannibal.Models.Endpoint>? _listEndpoints = null;
    private IdentityUser? _user = null;
    private bool _showRulesDetails = false;
    private bool _showCreateForm = false;
    private bool _isCreating = false;

    [SupplyParameterFromForm] private Hannibal.Models.Rule _editRule { get; set; } = new() { Id = -1 };
    [SupplyParameterFromForm] private Hannibal.Models.Rule? _newRule { get; set; } = null;

    [SupplyParameterFromForm] private double _editMaxDestAge { get; set; }
    [SupplyParameterFromForm] private double _editMinRetryTime { get; set; }
    [SupplyParameterFromForm] private double _editDailyTriggerTime { get; set; }
    private int _editSourceEndpointId { get; set; } = -1;
    private Hannibal.Models.Endpoint? _editSourceEndpoint = null;
    private int _editDestinationEndpointId { get; set; } = -1;
    private Hannibal.Models.Endpoint? _editDestinationEndpoint = null;
    private int _editRuleId { get; set; } = -1;

    [SupplyParameterFromForm] private float _newMaxDestAge { get; set; } = 36 * 3600;
    [SupplyParameterFromForm] private float _newMinRetryTime { get; set; } = 60;
    [SupplyParameterFromForm] private double _newDailyTriggerTime { get; set; } = 2 * 3600;
    private int _newSourceEndpointId { get; set; } = -1;
    private Hannibal.Models.Endpoint? _newSourceEndpoint = null;
    private int _newDestinationEndpointId { get; set; } = -1;
    private Hannibal.Models.Endpoint? _newDestinationEndpoint = null;

    /// <summary>
    /// Format a TimeSpan duration into a human-readable string (e.g., "24h", "1h", "60s")
    /// </summary>
    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalDays >= 1)
            return $"{duration.TotalDays:0.#}d";
        if (duration.TotalHours >= 1)
            return $"{duration.TotalHours:0.#}h";
        if (duration.TotalMinutes >= 1)
            return $"{duration.TotalMinutes:0.#}m";
        return $"{duration.TotalSeconds:0}s";
    }

    /// <summary>
    /// Format a TimeSpan as time of day (e.g., "2:00 AM", "6:00 PM")
    /// </summary>
    private string FormatTimeOfDay(TimeSpan time)
    {
        var dt = DateTime.Today.Add(time);
        return dt.ToString("h:mm tt");
    }

    public void Dispose()
    {
        // Dispose logic if needed
    }


    private async Task _onFlush()
    {
        try
        {
            await HannibalServiceClient.FlushRulesAsync(CancellationToken.None);
        }
        catch (Exception e)
        {
        }
    }

    private void _onShowCreateForm()
    {
        _resetNewRuleForm();
        _showCreateForm = true;
    }

    private void _onCancelCreate()
    {
        _showCreateForm = false;
        _resetNewRuleForm();
    }

    private void _resetNewRuleForm()
    {
        _newRule = new() { UserId = _user?.Id ?? "" };
        _newMaxDestAge = 36 * 3600;
        _newMinRetryTime = 60;
        _newDailyTriggerTime = 2 * 3600;
        _newSourceEndpoint = _listEndpoints?.FirstOrDefault();
        _newSourceEndpointId = _newSourceEndpoint?.Id ?? -1;
        _newDestinationEndpoint = _listEndpoints?.FirstOrDefault();
        _newDestinationEndpointId = _newDestinationEndpoint?.Id ?? -1;
        if (_newRule != null)
        {
            _newRule.SourceEndpoint = _newSourceEndpoint;
            _newRule.SourceEndpointId = _newSourceEndpointId;
            _newRule.DestinationEndpoint = _newDestinationEndpoint;
            _newRule.DestinationEndpointId = _newDestinationEndpointId;
        }
    }
    
    private void _onEditSourceEndpointChanged()
    {
        if (null == _listEndpoints || null == _editRule)
        {
            return;
        }
        _editSourceEndpoint = _listEndpoints.First(storage => (storage.Id == (int)_editSourceEndpointId));
        _editSourceEndpointId = _editSourceEndpoint.Id;
        _editRule.SourceEndpoint = _editSourceEndpoint;
        _editRule.SourceEndpointId = _editSourceEndpointId;
    }


    private void _onEditDestinationEndpointChanged()
    {
        if (null == _listEndpoints || null == _editRule)
        {
            return;
        }
        _editDestinationEndpoint = _listEndpoints.First(storage => (storage.Id == (int)_editDestinationEndpointId));
        _editDestinationEndpointId = _editDestinationEndpoint.Id;
        _editRule.DestinationEndpoint = _editDestinationEndpoint;
        _editRule.DestinationEndpointId = _editDestinationEndpointId;
    }


    private async Task _reloadRulePage(CancellationToken cancellationToken)
    {
        _listRules = new List<Hannibal.Models.Rule>(
            await HannibalServiceClient.GetRulesAsync(new ResultPage()
                {
                    Length = 20, Offset = 0
                },
                new RuleFilter {},
                CancellationToken.None)
        );
    }
    

    private async Task _onEditRuleCancel()
    {
        _editRuleId = -1;
        _editRule = new() { Id = -1 };
        await InvokeAsync(StateHasChanged);      
    }


    private async Task _onEditRuleSubmit()
    {
        if (_editRule != null)
        {
            _editRule.MaxDestinationAge = TimeSpan.FromSeconds(_editMaxDestAge);
            _editRule.MinRetryTime = TimeSpan.FromSeconds(_editMinRetryTime);
            _editRule.DailyTriggerTime = TimeSpan.FromSeconds(_editDailyTriggerTime);
            await HannibalServiceClient.UpdateRuleAsync(_editRule.Id, _editRule, CancellationToken.None);
        }

        _editRuleId = -1;
        _editRule = new() { Id = -1 };
        await InvokeAsync(StateHasChanged);
    }

    
    private async Task _onEdit(Hannibal.Models.Rule? ru)
    {
        if (ru != null || _listEndpoints != null)
        {
            _editRuleId = ru.Id;
            _editRule = ru;
            _editSourceEndpoint = ru.SourceEndpoint;
            _editSourceEndpointId = ru.SourceEndpointId;
            _editDestinationEndpoint = ru.DestinationEndpoint;
            _editDestinationEndpointId = ru.DestinationEndpointId;
            _editMaxDestAge = ru.MaxDestinationAge.TotalSeconds;
            _editMinRetryTime = ru.MinRetryTime.TotalSeconds;
            _editDailyTriggerTime = ru.DailyTriggerTime.TotalSeconds;
        }
        else
        {
            _editRuleId = -1;
            _editRule = new() { Id = -1 };
        }

        await InvokeAsync(StateHasChanged);      
    }


    private void _onNewSourceEndpointChanged()
    {
        if (null == _listEndpoints || null == _newRule)
        {
            return;
        }
        _newSourceEndpoint = _listEndpoints.First(storage => (storage.Id == (int)_newSourceEndpointId));
        _newSourceEndpointId = _newSourceEndpoint.Id;
        _newRule.SourceEndpoint = _newSourceEndpoint;
        _newRule.SourceEndpointId = _newSourceEndpointId;
    }


    private void _onNewDestinationEndpointChanged()
    {
        if (null == _listEndpoints || null == _newRule)
        {
            return;
        }
        _newDestinationEndpoint = _listEndpoints.First(storage => (storage.Id == (int)_newDestinationEndpointId));
        _newDestinationEndpointId = _newDestinationEndpoint.Id;
        _newRule.DestinationEndpoint = _newDestinationEndpoint;
        _newRule.DestinationEndpointId = _newDestinationEndpointId;
    }
    

    private async Task _onNewRuleSubmit()
    {
        if (_newRule.SourceEndpoint == null
            || _newRule.DestinationEndpoint == null
            || _newRule.SourceEndpoint == _newRule.DestinationEndpoint)
        {
            return;
        }

        _isCreating = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            _newRule.DailyTriggerTime = TimeSpan.FromSeconds(_newDailyTriggerTime);
            _newRule.MaxDestinationAge = TimeSpan.FromSeconds(_newMaxDestAge);
            _newRule.MinRetryTime = TimeSpan.FromSeconds(_newMinRetryTime);
            
            await HannibalServiceClient.CreateRuleAsync(_newRule, CancellationToken.None);
            await _reloadRulePage(CancellationToken.None);
            
            // Success - close form and reset
            _showCreateForm = false;
            _resetNewRuleForm();
        }
        catch (Exception e)
        {
            // Stay open on error
        }
        finally
        {
            _isCreating = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    
    
    private async Task _onDelete(Hannibal.Models.Rule ru)
    {
        await HannibalServiceClient.DeleteRuleAsync(ru.Id, CancellationToken.None);
        await _reloadRulePage(CancellationToken.None);
        await InvokeAsync(StateHasChanged);      
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (AuthState.ReadResetRedirectToLogin())
        {
            await InvokeAsync(() =>
            {
                Task.Delay(200);
                Navigation.NavigateTo("/login");
            });
        }
    }
    
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            _user = await HannibalServiceClient.GetUserAsync(-1, CancellationToken.None);
            if (null == _user)
            {
                AuthState.TriggerRedirectToLogin();
            }
    
            _listEndpoints = new List<Hannibal.Models.Endpoint>(
                await HannibalServiceClient.GetEndpointsAsync(CancellationToken.None)
            );
    
            _newRule = new() { UserId = _user.Id };
            _newSourceEndpoint = _listEndpoints.FirstOrDefault(ep => true);
            _newSourceEndpointId = (_newSourceEndpoint != null) ? _newSourceEndpoint.Id : -1;
            _newDestinationEndpoint = _listEndpoints.FirstOrDefault(ep => true);
            _newDestinationEndpointId = (_newDestinationEndpoint != null) ? _newDestinationEndpoint.Id : -1;
            _newRule.SourceEndpoint = _newSourceEndpoint;
            _newRule.SourceEndpointId = _newSourceEndpointId;
            _newRule.DestinationEndpoint = _newDestinationEndpoint;
            _newRule.DestinationEndpointId = _newDestinationEndpointId;
    
            await _reloadRulePage(CancellationToken.None);
    
            // Load rule states
            var states = await HannibalServiceClient.GetRuleStatesAsync(CancellationToken.None);
            foreach (var state in states)
            {
                _ruleStates[state.RuleId] = state;
            }
        }
        catch (Exception e)
        {
            // TXWTODO: Catch 401 ?
        }
    }


}
