@page "/backer/endpoints"
@using Hannibal.Client
@using Microsoft.AspNetCore.Identity
@using Poe.Services
@inject IHannibalServiceClient HigginsServiceClient
@inject NavigationManager Navigation
@inject Tools.AppBasePath BasePath
@inject AuthState AuthState
@implements IDisposable
@rendermode InteractiveServer


<h3>Endpoints</h3>

<div class="alert alert-info mb-4" role="alert">
    <h5 class="alert-heading"><span class="me-2">üìÅ</span>Backup Endpoints</h5>
    <p class="mb-2">
        Endpoints define specific folder locations within your storages. Each endpoint points to a folder that can be used as a source (where to backup from) or destination (where to backup to) in your backup rules.
    </p>
    <hr>
    <p class="mb-0"><strong>How to use:</strong></p>
    <ul class="mb-0 mt-2">
        <li><strong>Name</strong> ‚Äî Give your endpoint a descriptive name (e.g., "My Documents", "Cloud Backup Folder", "Photos Archive").</li>
        <li><strong>Storage</strong> ‚Äî Select which storage connection this endpoint belongs to.</li>
        <li><strong>Path</strong> ‚Äî Specify the folder path relative to the storage root (e.g., "Documents/Work" or "Backups/Daily").</li>
    </ul>
    <p class="mt-2 mb-0"><em>Tip: Create separate endpoints for different folders you want to backup, even within the same storage.</em></p>
</div>

@if (_listEndpoints == null)
{
    <p><em>Loading endpoints...</em></p>
}
else
{
    <table class="table">
        <thead>
        <tr>
            <th>&nbsp;</th>
            <th title="Friendly name for this endpoint">Name</th>
            <th title="The storage connection this endpoint uses">Storage</th>
            <th title="Folder path within the storage">Path</th>
            <th title="Optional notes">Comment</th>
            <th>&nbsp;</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var ep in _listEndpoints)
        {
            @if (_editingEndpointId == ep.Id)
            {
                    <tr>
                        <td>&nbsp;</td>
                        <td><InputText id="name" class="form-control" @bind-Value="_editingEndpoint.Name" title="A descriptive name for this endpoint"/></td>
                        <td>
                            <InputSelect id="storage"
                                         placeholder="Storage"
                                         class="form-control"
                                         title="The storage connection this endpoint belongs to"
                                         @bind-Value="_editingEndpointStorageId"
                                         @bind-Value:after="_handleEditStorageChanged">
                                @foreach (var st in _listStorages)
                                {
                                    <option value="@st.Id">@st.Technology</option>
                                }
                            </InputSelect>
                        </td>
                        <td><InputText id="path" @bind-Value="_editingEndpoint.Path" class="form-control" title="Folder path relative to the storage root"/></td>
                        <td><InputText id="comment" @bind-Value="_editingEndpoint.Comment" class="form-control" title="Optional notes for your reference"/></td>
                        <td>
                            <button @onclick="_onEditEndpointSubmit" id="submiteditendpoint" class="close" title="Save changes">‚úî</button>
                            <button @onclick="_onEditEndpointCancel" class="close" aria-label="cancel" title="Cancel editing">‚ùåÔ∏è</button>
                        </td>
                    </tr>
                
            } else
            {
                <tr>
                    <td><button id="starteditendpoint" @onclick="() => _onEdit(ep)" aria-label="edit" title="Edit this endpoint">‚úè</button></td>
                    <td>@ep.Name</td>
                    <td>@ep.Storage.Technology</td>
                    <td>@ep.Path</td>
                    <td>@ep.Comment</td>
                    <td>
                        <button @onclick="() => _onDelete(ep)" class="close" aria-label="delete" title="Delete this endpoint">üóëÔ∏è</button>
                    </td>
                </tr>
            }
        }
        </tbody>
    </table>
}

@if (_listStorages == null)
{
    <p><em>Loading storages</em></p>
} else if (!_listStorages.Any())
{
    <p>No storages defined. Please define storages before defining endpoints inside them.</p>
}
else
{
    <h2>Create new endpoint</h2>
    <div class="row">
        <div class="col-md-6">
            <EditForm method="post" Model="_newEndpoint" OnValidSubmit="AddEndpoint" FormName="create" Enhance>
                <DataAnnotationsValidator/>
                <ValidationSummary class="text-danger"/>
                <div class="mb-3">
                    <label for="name" class="form-label">Name: <span class="text-danger">*</span></label>
                    <InputText id="name"
                               placeholder="My Documents Backup"
                               class="form-control"
                               title="A friendly name to identify this endpoint. Use something descriptive like 'Work Documents' or 'Photos Backup'."
                               @bind-Value="_newEndpoint.Name" />
                    <small class="form-text text-muted">A descriptive name to identify this folder location</small>
                    <ValidationMessage For="() => _newEndpoint.Name" class="text-danger"/>
                </div>
                <div class="mb-3">
                    <label for="storage" class="form-label">Storage: <span class="text-danger">*</span></label>
                    <InputSelect id="storage"
                                 placeholder="Storage"
                                 class="form-control"
                                 title="Select the storage connection where this folder is located. You must create a storage first before creating endpoints."
                                 @bind-Value="_newEndpointStorageId" 
                                 @bind-Value:after="handleNewStorageChanged" 
                                 >
                        @foreach (var storage in _listStorages)
                        {
                            <option value="@storage.Id">@storage.Technology</option>
                        }
                    </InputSelect>
                    <small class="form-text text-muted">The storage connection this endpoint belongs to</small>
                </div>
                <div class="mb-3">
                    <label for="path" class="form-label">Path: <span class="text-danger">*</span></label>
                    <InputText id="path"
                               placeholder="Documents/Work or Backups/Daily"
                               class="form-control"
                               title="The folder path relative to the storage root. For cloud storage, this is the path within your cloud drive. For SMB, this is the path within the share."
                               @bind-Value="_newEndpoint.Path"/>
                    <small class="form-text text-muted">Folder path relative to the storage root (e.g., "Documents" or "Backups/2024")</small>
                    <ValidationMessage For="() => _newEndpoint.Path" class="text-danger"/>
                </div>
                <div class="mb-3">
                    <label for="comment" class="form-label">Comment (optional):</label>
                    <InputText id="comment"
                               placeholder="Optional notes about this endpoint"
                               class="form-control"
                               title="Add any notes or reminders about this endpoint for your own reference."
                               @bind-Value="_newEndpoint.Comment" />
                    <small class="form-text text-muted">Optional notes for your own reference</small>
                    <ValidationMessage For="() => _newEndpoint.Comment" class="text-danger"/>
                </div>
                <button type="submit" class="btn btn-primary">Create Endpoint</button>
            </EditForm>
        </div>
    </div>
}


@code {
    private List<Hannibal.Models.Endpoint>? _listEndpoints = null;
    private List<Hannibal.Models.Storage>? _listStorages = null;
    private IdentityUser? _user = null;

    private int _editingEndpointId { get; set; } = -1;
    private int _editingEndpointStorageId { get; set; } = -1;

    [SupplyParameterFromForm] private Hannibal.Models.Endpoint? _editingEndpoint { get; set; } = new() { Id = -1 };

    private int _newEndpointStorageId { get; set; } = -1;
    [SupplyParameterFromForm] private Hannibal.Models.Endpoint? _newEndpoint { get; set; } = null;

    private Hannibal.Models.Storage? _selectedStorage = null;


    public void Dispose()
    {
        // Dispose logic if needed
    }

    
    private void handleNewStorageChanged()
    {
        if (null == _listStorages || null == _newEndpoint)
        {
            return;
        }
        _selectedStorage = _listStorages.First(storage => (storage.Id == (int)_newEndpointStorageId));

        _newEndpoint.StorageId = _newEndpointStorageId;
        _newEndpoint.Storage = _selectedStorage;
    }



    private void _handleEditStorageChanged()
    {
        if (null == _listStorages || null == _editingEndpoint)
        {
            return;
        }
        _editingEndpoint.Storage = _listStorages.First(storage => (storage.Id == _editingEndpointStorageId));
        _editingEndpoint.StorageId = _editingEndpoint.Storage.Id;
    }


    private async Task _onEdit(Hannibal.Models.Endpoint? ep)
    {
        if (ep != null)
        {
            _editingEndpointId = ep.Id;
            _editingEndpoint = ep;
            _editingEndpointStorageId = ep.StorageId;
        }
        else
        {
            _editingEndpointId = -1;
            _editingEndpoint = new() { Id = -1 };
            _editingEndpointStorageId = -1;
        }
        
        await InvokeAsync(StateHasChanged);      
    }


    private async Task _onDelete(Hannibal.Models.Endpoint ep)
    {
        await HigginsServiceClient.DeleteEndpointAsync(ep.Id, CancellationToken.None);
        _listEndpoints = new List<Hannibal.Models.Endpoint>(
            await HigginsServiceClient.GetEndpointsAsync(CancellationToken.None)
        );
        await InvokeAsync(StateHasChanged);      
    }
    
    
    private async Task _onEditEndpointCancel()
    {
        _editingEndpointId = -1;
        _editingEndpoint = new() { Id = -1};
        await InvokeAsync(StateHasChanged);      
    }


    private async Task _onEditEndpointSubmit()
    {
        if (_editingEndpoint != null)
        {
            await HigginsServiceClient.UpdateEndpointAsync(_editingEndpoint.Id, _editingEndpoint, CancellationToken.None);
        }

        _editingEndpointId = -1;
        _editingEndpoint = new() { Id = -1 };
        await InvokeAsync(StateHasChanged);
    }


    private async Task AddEndpoint()
    {
        // TXWTODO: Where to actually validate before submiit?

        if (null == _newEndpoint.Storage || string.IsNullOrWhiteSpace(_newEndpoint.Name))
        {
            return;
        }
        
        await HigginsServiceClient.CreateEndpointAsync(_newEndpoint, CancellationToken.None);
        _listEndpoints = new List<Hannibal.Models.Endpoint>(
            await HigginsServiceClient.GetEndpointsAsync(CancellationToken.None)
        );
        await InvokeAsync(StateHasChanged);      
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (AuthState.ReadResetRedirectToLogin())
        {
            await InvokeAsync(() =>
            {
                Task.Delay(200);
                Navigation.NavigateTo("/login");
            });
        }
    }
    
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            _user = await HigginsServiceClient.GetUserAsync(-1, CancellationToken.None);
            if (null == _user)
            {
                Navigation.NavigateTo($"{BasePath.Value}/login");
            }

            _newEndpoint = new() { UserId = _user.Id, IsActive = true };

            _listEndpoints = new List<Hannibal.Models.Endpoint>(
                await HigginsServiceClient.GetEndpointsAsync(CancellationToken.None)
            );
            _listStorages = new List<Hannibal.Models.Storage>(
                await HigginsServiceClient.GetStoragesAsync(CancellationToken.None)
            );
        }
        catch (Exception e)
        {
            // TXWTODO: Catch 401 ?            
        }
    }
}