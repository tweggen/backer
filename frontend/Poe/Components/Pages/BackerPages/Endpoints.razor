@page "/backer/endpoints"
@using Hannibal.Client
@using Microsoft.AspNetCore.Identity
@using Poe.Services
@inject IHannibalServiceClient HigginsServiceClient
@inject NavigationManager Navigation
@inject Tools.AppBasePath BasePath
@inject AuthState AuthState
@implements IDisposable
@rendermode InteractiveServer


<h3>Endpoints</h3>

<div class="alert alert-info mb-4" role="alert">
    <p class="mb-0">
        Endpoints define specific folder locations within your storages. Each endpoint points to a folder that can be used as a source or destination in your backup rules.
        <button type="button" class="info-toggle" @onclick="() => _showEndpointsDetails = !_showEndpointsDetails">@(_showEndpointsDetails ? "less details..." : "more details...")</button>
    </p>
    @if (_showEndpointsDetails)
    {
        <hr>
        <p class="mb-0"><strong>How to use:</strong></p>
        <ul class="mb-0 mt-2">
            <li><strong>Name</strong> ‚Äî Give your endpoint a descriptive name (e.g., "My Documents", "Cloud Backup Folder", "Photos Archive").</li>
            <li><strong>Storage</strong> ‚Äî Select which storage connection this endpoint belongs to.</li>
            <li><strong>Path</strong> ‚Äî Specify the folder path:
                <ul>
                    <li><em>For SMB/Network shares:</em> Include the <strong>share name</strong> followed by the folder path (e.g., <code>DATA/Documents</code> or <code>Backup/Photos/2024</code>)</li>
                    <li><em>For Cloud storage:</em> Folder path within your cloud drive (e.g., <code>Documents/Work</code>)</li>
                    <li><em>For Local storage:</em> Folder path relative to the storage base path</li>
                </ul>
            </li>
        </ul>
        <p class="mt-2 mb-0"><em>Tip: Create separate endpoints for different folders you want to backup, even within the same storage.</em></p>
    }
</div>

@if (_listEndpoints == null)
{
    <p><em>Loading endpoints...</em></p>
}
else
{
    @* === CARD VIEW (used for both mobile and desktop) === *@
    <div class="endpoints-card-list">
        @foreach (var ep in _listEndpoints)
        {
            @if (_editingEndpointId == ep.Id)
            {
                @* Edit mode card *@
                <div class="endpoint-card endpoint-card-edit">
                    <div class="form-group">
                        <label>Name</label>
                        <InputText class="form-control" @bind-Value="_editingEndpoint.Name" placeholder="Endpoint name"/>
                    </div>
                    <div class="form-group">
                        <label>Storage</label>
                        <InputSelect class="form-control"
                                     @bind-Value="_editingEndpointStorageId"
                                     @bind-Value:after="_handleEditStorageChanged">
                            @foreach (var st in _listStorages)
                            {
                                <option value="@st.Id">@st.UriSchema (@st.Technology)</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="form-group">
                        <label>Path</label>
                        <InputText class="form-control" @bind-Value="_editingEndpoint.Path" placeholder="Folder path"/>
                    </div>
                    <div class="form-group">
                        <label>Comment</label>
                        <InputText class="form-control" @bind-Value="_editingEndpoint.Comment" placeholder="Optional notes"/>
                    </div>
                    <div class="endpoint-card-edit-actions">
                        <button class="btn-cancel" @onclick="_onEditEndpointCancel">Cancel</button>
                        <button class="btn-save" @onclick="_onEditEndpointSubmit">Save</button>
                    </div>
                </div>
            }
            else
            {
                @* View mode card *@
                <div class="endpoint-card">
                    <div class="endpoint-card-header">
                        <h4 class="endpoint-card-title">üìÅ @ep.Name</h4>
                        <button class="btn-edit" @onclick="() => _onEdit(ep)" title="Edit">‚úèÔ∏è</button>
                    </div>
                    <div class="endpoint-card-main">
                        <div class="endpoint-card-storage">@ep.Storage.UriSchema (@ep.Storage.Technology)</div>
                        <div class="endpoint-card-path">@ep.Path</div>
                    </div>
                    <div class="endpoint-card-right">
                        <button class="btn-delete" @onclick="() => _onDelete(ep)" title="Delete">üóëÔ∏è</button>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(ep.Comment))
                    {
                        <div class="endpoint-card-footer">
                            <div class="endpoint-card-comment">@ep.Comment</div>
                        </div>
                    }
                </div>
            }
        }
    </div>
}

@if (_listStorages == null)
{
    <p><em>Loading storages</em></p>
} else if (!_listStorages.Any())
{
    <p>No storages defined. Please define storages before defining endpoints inside them.</p>
}
else
{
    @* === COLLAPSIBLE CREATE FORM === *@
    <div class="create-section mt-4">
        @if (!_showCreateForm)
        {
            <button type="button" class="btn btn-outline-primary" @onclick="_onShowCreateForm">
                ‚ûï Create new endpoint...
            </button>
        }
        else
        {
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Create new endpoint</h5>
                    <button type="button" class="btn-close" @onclick="_onCancelCreate" title="Cancel"></button>
                </div>
                <div class="card-body">
                    <EditForm method="post" Model="_newEndpoint" OnValidSubmit="AddEndpoint" FormName="create" Enhance>
                        <DataAnnotationsValidator/>
                        <ValidationSummary class="text-danger"/>
                        <fieldset disabled="@_isCreating">
                            <div class="mb-3">
                                <label for="name" class="form-label">Name: <span class="text-danger">*</span></label>
                                <InputText id="name" placeholder="My Documents Backup" class="form-control" @bind-Value="_newEndpoint.Name" />
                                <small class="form-text text-muted">A descriptive name to identify this folder location</small>
                            </div>
                            <div class="mb-3">
                                <label for="storage" class="form-label">Storage: <span class="text-danger">*</span></label>
                                <InputSelect id="storage" class="form-control" @bind-Value="_newEndpointStorageId" @bind-Value:after="handleNewStorageChanged">
                                    @foreach (var storage in _listStorages)
                                    {
                                        <option value="@storage.Id">@storage.UriSchema (@storage.Technology)</option>
                                    }
                                </InputSelect>
                                <small class="form-text text-muted">The storage connection this endpoint belongs to</small>
                            </div>
                            <div class="mb-3">
                                <label for="path" class="form-label">Path: <span class="text-danger">*</span></label>
                                <InputText id="path" placeholder="@GetPathPlaceholder()" class="form-control" @bind-Value="_newEndpoint.Path"/>
                                <small class="form-text text-muted">@GetPathHelpText()</small>
                            </div>
                            <div class="mb-3">
                                <label for="comment" class="form-label">Comment (optional):</label>
                                <InputText id="comment" placeholder="Optional notes" class="form-control" @bind-Value="_newEndpoint.Comment" />
                            </div>
                        </fieldset>
                        <div class="d-flex gap-2 justify-content-end">
                            <button type="button" class="btn btn-secondary" @onclick="_onCancelCreate" disabled="@_isCreating">Cancel</button>
                            <button type="submit" class="btn btn-primary" disabled="@_isCreating">
                                @if (_isCreating)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                }
                                Create Endpoint
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        }
    </div>
}


@code {
    private List<Hannibal.Models.Endpoint>? _listEndpoints = null;
    private List<Hannibal.Models.Storage>? _listStorages = null;
    private IdentityUser? _user = null;
    private bool _showEndpointsDetails = false;
    private bool _showCreateForm = false;
    private bool _isCreating = false;

    private int _editingEndpointId { get; set; } = -1;
    private int _editingEndpointStorageId { get; set; } = -1;

    [SupplyParameterFromForm] private Hannibal.Models.Endpoint? _editingEndpoint { get; set; } = new() { Id = -1 };

    private int _newEndpointStorageId { get; set; } = -1;
    [SupplyParameterFromForm] private Hannibal.Models.Endpoint? _newEndpoint { get; set; } = null;

    private Hannibal.Models.Storage? _selectedStorage = null;

    /// <summary>
    /// Get placeholder text for the Path field based on selected storage type
    /// </summary>
    private string GetPathPlaceholder()
    {
        if (_selectedStorage == null) return "Select a storage first";
        
        return _selectedStorage.Technology?.ToLowerInvariant() switch
        {
            "smb" => "ShareName/Folder/Subfolder (e.g., DATA/Documents)",
            "local" => "Folder/Subfolder (e.g., Documents/Work)",
            "onedrive" or "dropbox" or "googledrive" => "Folder/Subfolder (e.g., Backups/Daily)",
            _ => "Folder path"
        };
    }

    /// <summary>
    /// Get tooltip text for the Path field based on selected storage type
    /// </summary>
    private string GetPathTooltip()
    {
        if (_selectedStorage == null) return "Select a storage first to see path format";
        
        return _selectedStorage.Technology?.ToLowerInvariant() switch
        {
            "smb" => "For SMB: Start with the SHARE NAME, then add the folder path. Example: 'DATA/Documents/Work' accesses \\\\server\\DATA\\Documents\\Work",
            "local" => "Folder path relative to the storage base path on the agent machine.",
            "onedrive" or "dropbox" or "googledrive" => "Folder path within your cloud storage. Leave empty for root.",
            _ => "Folder path within this storage"
        };
    }

    /// <summary>
    /// Get help text for the Path field based on selected storage type
    /// </summary>
    private string GetPathHelpText()
    {
        if (_selectedStorage == null) return "Select a storage to see path format guidance";
        
        return _selectedStorage.Technology?.ToLowerInvariant() switch
        {
            "smb" => $"Format: ShareName/Path ‚Äî e.g., 'DATA/Documents' connects to \\\\{_selectedStorage.Host}\\DATA\\Documents",
            "local" => "Folder path relative to the storage base path",
            "onedrive" or "dropbox" or "googledrive" => "Folder path in your cloud drive (e.g., 'Backups/Daily')",
            _ => "Folder path within this storage"
        };
    }


    public void Dispose()
    {
        // Dispose logic if needed
    }

    private void _onShowCreateForm()
    {
        _resetNewEndpointForm();
        _showCreateForm = true;
    }

    private void _onCancelCreate()
    {
        _showCreateForm = false;
        _resetNewEndpointForm();
    }

    private void _resetNewEndpointForm()
    {
        _newEndpoint = new() { UserId = _user?.Id ?? "", IsActive = true };
        _selectedStorage = _listStorages?.FirstOrDefault();
        _newEndpointStorageId = _selectedStorage?.Id ?? -1;
        if (_newEndpoint != null && _selectedStorage != null)
        {
            _newEndpoint.StorageId = _newEndpointStorageId;
            _newEndpoint.Storage = _selectedStorage;
        }
    }

    
    private void handleNewStorageChanged()
    {
        if (null == _listStorages || null == _newEndpoint)
        {
            return;
        }
        _selectedStorage = _listStorages.First(storage => (storage.Id == (int)_newEndpointStorageId));

        _newEndpoint.StorageId = _newEndpointStorageId;
        _newEndpoint.Storage = _selectedStorage;
    }



    private void _handleEditStorageChanged()
    {
        if (null == _listStorages || null == _editingEndpoint)
        {
            return;
        }
        _editingEndpoint.Storage = _listStorages.First(storage => (storage.Id == _editingEndpointStorageId));
        _editingEndpoint.StorageId = _editingEndpoint.Storage.Id;
    }


    private async Task _onEdit(Hannibal.Models.Endpoint? ep)
    {
        if (ep != null)
        {
            _editingEndpointId = ep.Id;
            _editingEndpoint = ep;
            _editingEndpointStorageId = ep.StorageId;
        }
        else
        {
            _editingEndpointId = -1;
            _editingEndpoint = new() { Id = -1 };
            _editingEndpointStorageId = -1;
        }
        
        await InvokeAsync(StateHasChanged);      
    }


    private async Task _rereadListEndpoints()
    {
        _listEndpoints = new List<Hannibal.Models.Endpoint>(
            (await HigginsServiceClient.GetEndpointsAsync(CancellationToken.None))
            .OrderBy(ep => ep.Name)
        );
    }


    private async Task _rereadListStorages()
    {
        _listStorages = new List<Hannibal.Models.Storage>(
            (await HigginsServiceClient.GetStoragesAsync(CancellationToken.None))
            .OrderBy(st => st.Technology)
        );
    }

    private async Task _onDelete(Hannibal.Models.Endpoint ep)
    {
        await HigginsServiceClient.DeleteEndpointAsync(ep.Id, CancellationToken.None);
        await _rereadListEndpoints();
        await InvokeAsync(StateHasChanged);      
    }
    
    
    private async Task _onEditEndpointCancel()
    {
        _editingEndpointId = -1;
        _editingEndpoint = new() { Id = -1};
        await InvokeAsync(StateHasChanged);      
    }


    private async Task _onEditEndpointSubmit()
    {
        if (_editingEndpoint != null)
        {
            await HigginsServiceClient.UpdateEndpointAsync(_editingEndpoint.Id, _editingEndpoint, CancellationToken.None);
        }

        _editingEndpointId = -1;
        _editingEndpoint = new() { Id = -1 };
        await InvokeAsync(StateHasChanged);
    }


    private async Task AddEndpoint()
    {
        if (null == _newEndpoint.Storage || string.IsNullOrWhiteSpace(_newEndpoint.Name))
        {
            return;
        }

        _isCreating = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            await HigginsServiceClient.CreateEndpointAsync(_newEndpoint, CancellationToken.None);
            await _rereadListEndpoints();
            
            // Success - close form and reset
            _showCreateForm = false;
            _resetNewEndpointForm();
        }
        catch (Exception e)
        {
            // Stay open on error
        }
        finally
        {
            _isCreating = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (AuthState.ReadResetRedirectToLogin())
        {
            await InvokeAsync(() =>
            {
                Task.Delay(200);
                Navigation.NavigateTo("/login");
            });
        }
    }
    
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            _user = await HigginsServiceClient.GetUserAsync(-1, CancellationToken.None);
            if (null == _user)
            {
                Navigation.NavigateTo($"{BasePath.Value}/login");
            }

            _newEndpoint = new() { UserId = _user.Id, IsActive = true };

            await _rereadListEndpoints();
            await _rereadListStorages();
        }
        catch (Exception e)
        {
            // TXWTODO: Catch 401 ?            
        }
    }
}
