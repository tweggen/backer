@page "/SignUp"
@layout Poe.Components.Layout.PublicLayout
@using Hannibal.Client
@using Microsoft.AspNetCore.Http.HttpResults
@using Microsoft.AspNetCore.Identity.Data
@inject IIdentityApiService IdentityApiService
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Navigation
@inject Tools.AppBasePath BasePath

<PageTitle>Sign Up - Backer</PageTitle>

<div class="signup-container">
    <div class="signup-card">
        <div class="signup-header">
            <h1 class="signup-title">
                <span>☁️</span> Backer
            </h1>
            <p class="signup-subtitle">Create your account</p>
        </div>

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="alert alert-danger">@ErrorMessage</div>
        }

        @if (!string.IsNullOrEmpty(SuccessMessage))
        {
            <div class="alert alert-success">@SuccessMessage</div>
        }

        <EditForm Model="@signupModel" OnValidSubmit="@HandleSignup" FormName="SignupForm" class="signup-form">
            <div class="mb-3">
                <label for="email" class="form-label">Email address</label>
                <InputText id="email" @bind-Value="signupModel.Username" class="form-control" placeholder="you@example.com" />
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <InputText id="password" @bind-Value="signupModel.Password" class="form-control" type="password" placeholder="••••••••" />
                <small class="form-text text-muted">At least 6 characters with uppercase, lowercase, and a number.</small>
            </div>
            <button type="submit" class="btn btn-success w-100">Create Account</button>
        </EditForm>

        <div class="signup-footer">
            Already have an account? <a href="@($"{BasePath.Value}/login")">Sign in</a>
        </div>
    </div>
</div>

@code {
    private string? ErrorMessage;
    private string? SuccessMessage;
    
    [SupplyParameterFromForm(FormName = "SignupForm")]
    private SignupModel signupModel { get; set; } = new();

    private async Task HandleSignup()
    {
        ErrorMessage = null;
        SuccessMessage = null;

        try
        {
            var registerRequest = new RegisterRequest()
            {
                Email = signupModel.Username, 
                Password = signupModel.Password
            };

            var result = await IdentityApiService.RegisterUserAsync(registerRequest, CancellationToken.None);
                
            if (result.Result is Ok)
            {
                SuccessMessage = "Account created successfully! Redirecting to login...";
                HttpContextAccessor.HttpContext!.Response.Redirect($"{BasePath.Value}/login");
            } 
            else if (result.Result is ValidationProblem validationProblem)
            {
                var errors = validationProblem.ProblemDetails.Errors
                    .SelectMany(kvp => kvp.Value)
                    .ToList();
                ErrorMessage = string.Join(" ", errors);
            }
            else
            {
                ErrorMessage = "Registration failed. Please try again.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Registration failed: {ex.Message}";
        }
    }
    
    public class SignupModel
    {
        public string Username { get; set; } = "";
        public string Password { get; set; } = "";
    }
}
